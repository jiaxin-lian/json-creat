<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON 比较工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --light: #f8fafc;
            --dark: #0f172a;
            --success: #10b981;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1), 0 2px 4px -1px rgba(0, 0, 0, .06);
            --card-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            padding: auto;
        }

        .container {
            padding: 20px;
            display: grid;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--dark);
        }

        .card {
            background: #fff;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: .3s;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05);
        }

        .muted {
            color: var(--secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .row {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }

        label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--dark);
        }

        input[type="file"] {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: var(--light);
            font-size: 14px;
        }

        .primary-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: .2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .primary-btn:active {
            transform: translateY(0);
        }

        .primary-btn:disabled {
            background: #93c5fd;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #cbd5e1;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: .2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .secondary-btn:hover {
            background: #e2e8f0;
        }

        .json-display-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .json-display {
            flex: 1;
            min-width: 300px;
            background: #fff;
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .json-header {
            background: var(--primary);
            color: #fff;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .json-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .json-content {
            display: none;
            padding: 0;
        }

        .json-content.expanded {
            display: block;
        }

        .code {
            background: #0f172a;
            color: #e2e8f0;
            padding: 16px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 500px;
            white-space: pre-wrap;
        }

        nav {
            background: var(--primary);
            color: #fff;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            margin-right: 24px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: .2s;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, .1);
        }

        .nav-links a.active {
            background: rgba(255, 255, 255, .2);
        }

        @media (max-width:1200px) {
            .json-display-container {
                flex-direction: column
            }

            .json-display {
                min-width: 100%
            }
        }

        @media (max-width:768px) {
            .container {
                padding: 16px
            }

            .action-buttons {
                flex-direction: column
            }

            .primary-btn,
            .secondary-btn {
                width: 100%
            }
        }

        .fade-in {
            animation: fadeIn .5s ease-in-out
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .code::-webkit-scrollbar {
            width: 8px;
            height: 8px
        }

        .code::-webkit-scrollbar-track {
            background: #1e293b
        }

        .code::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px
        }

        .code::-webkit-scrollbar-thumb:hover {
            background: #64748b
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid var(--primary);
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }

        .info-box p {
            margin: 4px 0;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            border-top: 1px solid #1e293b;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-container">
            <div class="nav-links">
                <a href="index.html">创建 JSON</a>
                <a href="compare.html" class="active">比较 JSON</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h1 class="title">JSON 比较工具</h1>
            <p class="muted">上传两个 JSON 文件并查看修改的内容，自动生成操作 JSON（ops）。</p>
            <div class="info-box">
                <p><strong>结构：</strong><code>bookInfo</code>（对象）、<code>bookData</code>（对象）。每个单元对应一个数组，条目可用
                    <code>{word, meaning}</code> 或 <code>{w, def}</code>。
                </p>
                <p><strong>规则：</strong>生成
                    <code>addUnit / renameUnit / removeUnit / upsertItem / insertItemFirst / insertItemLast / insertItemAfter / updateItem / removeItem</code>
                    九种操作。
                </p>
            </div>
        </div>

        <div class="card">
            <div class="row">
                <label for="file1">选择第一个 JSON 文件（原始）</label>
                <input type="file" id="file1" accept=".json" />
            </div>
            <div class="row">
                <label for="file2">选择第二个 JSON 文件（目标/副本）</label>
                <input type="file" id="file2" accept=".json,.js" />
            </div>
            <div class="row">
                <button id="btn-compare-files" class="primary-btn">
                    <i class="fas fa-code-compare"></i> 生成过渡 JSON
                </button>
            </div>
        </div>

        <div class="json-display-container">
            <div class="json-display">
                <div class="json-header" data-target="json1-content">
                    <h2><i class="fas fa-file-code"></i> 第一个 JSON 文件</h2>
                    <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div id="json1-content" class="json-content">
                    <pre id="json1" class="code"></pre>
                </div>
            </div>

            <div class="json-display">
                <div class="json-header" data-target="json2-content">
                    <h2><i class="fas fa-file-code"></i> 第二个 JSON 文件</h2>
                    <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div id="json2-content" class="json-content">
                    <pre id="json2" class="code"></pre>
                </div>
            </div>

            <div class="json-display">
                <div class="json-header" data-target="compare-result-content">
                    <h2><i class="fas fa-gears"></i> 生成的操作 JSON（ops）</h2>
                    <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div id="compare-result-content" class="json-content">
                    <pre id="compare-result" class="code"></pre>
                    <div class="action-buttons">
                        <button id="btn-download" class="primary-btn" disabled>
                            <i class="fas fa-download"></i> 下载操作 JSON
                        </button>
                        <button id="btn-copy" class="secondary-btn" disabled>
                            <i class="fas fa-copy"></i> 复制操作 JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /** ========== 折叠/展开 ========== */
        document.querySelectorAll('.json-header').forEach(header => {
            header.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const target = document.getElementById(targetId);
                const icon = this.querySelector('.toggle-icon i');
                target.classList.toggle('expanded');
                icon.className = target.classList.contains('expanded') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
            });
        });
        // // 默认展开第一个
        // document.getElementById('json1-content').classList.add('expanded');
        // document.querySelector('[data-target="json1-content"] .toggle-icon i').className = 'fas fa-chevron-up';

        /** ========== 读文件并比较 ========== */
        document.getElementById('btn-compare-files').onclick = function () {
            const file1 = document.getElementById('file1').files[0];
            const file2 = document.getElementById('file2').files[0];
            if (!file1 || !file2) { alert("请上传两个文件！"); return; }

            const r1 = new FileReader(), r2 = new FileReader();
            r1.onload = (e1) => {
                let json1 = JSON.parse(e1.target.result);
                document.getElementById('json1').textContent = JSON.stringify(json1, null, 2);
                r2.onload = (e2) => {
                    let json2 = JSON.parse(e2.target.result);
                    document.getElementById('json2').textContent = JSON.stringify(json2, null, 2);
                    compareJSON(json1, json2);
                };
                r2.readAsText(file2);
            };
            r1.readAsText(file1);
        };

        /** ========== 下载/复制 ========== */
        document.getElementById('btn-download').onclick = function () {
            const jsonContent = document.getElementById('compare-result').textContent;
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "ops_patch.json";
            link.click();
        };
        document.getElementById('btn-copy').onclick = async function () {
            const jsonContent = document.getElementById('compare-result').textContent;
            try {
                await navigator.clipboard.writeText(jsonContent);
                alert("操作 JSON 已复制到剪贴板！");
            } catch {
                alert("复制失败，请手动复制！");
            }
        };

        /** ========== 核心：生成 9 种 ops ========== */

        /** 将 {word, meaning, ...} 统一映射为 {w, def, ...} */
        function normalizeItem(raw) {
            if (!raw) return null;
            const o = {};
            o.w = raw.w ?? raw.word ?? '';
            o.def = raw.def ?? raw.meaning ?? '';
            if ('id' in raw) o.id = raw.id;
            if ('tid' in raw) o.tid = raw.tid;
            if ('f' in raw) o.f = raw.f;
            return o;
        }
        function normalizeList(list) {
            return (Array.isArray(list) ? list : []).map(normalizeItem).filter(it => it && it.w);
        }
        function indexByW(list) {
            const m = new Map();
            list.forEach((it, i) => m.set(it.w, { i, it }));
            return m;
        }
        function diffSets(oldArr, newArr) {
            const oldSet = new Set(oldArr);
            const newSet = new Set(newArr);
            const added = [], removed = [], common = [];
            newArr.forEach(w => { if (!oldSet.has(w)) added.push(w); else common.push(w); });
            oldArr.forEach(w => { if (!newSet.has(w)) removed.push(w); });
            return { added, removed, common };
        }
        /** 找到目标序列 idx 左侧最近的、属于 allowed 的前驱词 */
        function findPrevAllowedWord(tgtWords, idx, allowed) {
            for (let j = idx - 1; j >= 0; j--) {
                const w = tgtWords[j];
                if (allowed.has(w)) return w;
            }
            return null;
        }
        /** 识别“移动” → upsertItem (pos=first/after) */
        function emitMoves(oldWords, tgtWords, unitTitle, ops, allowedNow) {
            let lastPlaced = null;
            for (let i = 0; i < tgtWords.length; i++) {
                const w = tgtWords[i];
                if (!allowedNow.has(w)) continue;

                const prev = findPrevAllowedWord(tgtWords, i, allowedNow);
                const needFirst = (prev === null);
                const ok =
                    (needFirst && lastPlaced === null) ||
                    (!needFirst && lastPlaced === prev);

                if (!ok) {
                    const move = { op: 'upsertItem', unitTitle, item: { id: null, w } };
                    if (needFirst) {
                        move.pos = 'first';
                    } else {
                        move.pos = 'after';
                        move.afterBy = { w: prev };
                    }
                    ops.push(move);
                    lastPlaced = w;
                } else {
                    lastPlaced = w;
                }
            }
        }

        /** 单元内差异 → 条目级 ops（增删改移） */
        function diffUnitItems(unitTitle, oldListRaw, newListRaw) {
            const ops = [];
            const oldList = normalizeList(oldListRaw);
            const newList = normalizeList(newListRaw);

            const oldIdx = indexByW(oldList);
            const newIdx = indexByW(newList);

            const oldWords = oldList.map(it => it.w);
            const newWords = newList.map(it => it.w);

            const { added, removed, common } = diffSets(oldWords, newWords);

            // 1) 释义变化 → updateItem
            common.forEach(w => {
                const o = oldIdx.get(w).it, n = newIdx.get(w).it;
                if ((o.def ?? '') !== (n.def ?? '')) {
                    ops.push({
                        op: 'updateItem',
                        unitTitle,
                        by: { w },
                        set: { id: null, w, def: n.def }
                    });
                }
            });

            // 2) 新增 → insertItemFirst / insertItemAfter / insertItemLast
            // 规则：在目标中依次处理新增词；若前面没有“已存在”前驱 → insertItemFirst；
            // 若该新增词位于目标数组末尾 → insertItemLast；
            // 否则 → insertItemAfter(最近前驱)。
            const allowedRefForPrev = new Set(oldWords); // 当前可作为前驱的集合（旧词 + 已新增过）
            for (let i = 0; i < newWords.length; i++) {
                const w = newWords[i];
                if (!added.includes(w)) continue;

                const prev = findPrevAllowedWord(newWords, i, allowedRefForPrev);
                const item = newIdx.get(w).it;

                if (prev === null) {
                    ops.push({
                        op: 'insertItemFirst',
                        unitTitle,
                        item: { id: null, w: item.w, def: item.def }
                    });
                } else if (i === newWords.length - 1) {
                    // 处于目标最后一位 → insertItemLast
                    ops.push({
                        op: 'insertItemLast',
                        unitTitle,
                        item: { id: null, w: item.w, def: item.def }
                    });
                } else {
                    ops.push({
                        op: 'insertItemAfter',
                        unitTitle,
                        item: { id: null, w: item.w, def: item.def },
                        afterBy: { w: prev }
                    });
                }
                allowedRefForPrev.add(w);
            }

            // 3) 删除 → removeItem
            removed.forEach(w => {
                ops.push({ op: 'removeItem', unitTitle, by: { w } });
            });

            // 4) 顺序变化（仅对“交集词”）→ upsertItem(pos=first/after)
            const allowedNow = new Set(newWords.filter(w => !added.includes(w)));
            emitMoves(oldWords, newWords, unitTitle, ops, allowedNow);

            return ops;
        }

        /** 可选：自动识别“重命名单元”（默认关闭以避免误判） */
        function tryGuessRenameUnits(oldBookData, newBookData) {
            const useRenameHeuristic = false; // 如需启用，改为 true
            if (!useRenameHeuristic) return [];
            const ops = [];

            const oldOnly = Object.keys(oldBookData).filter(u => !(u in newBookData));
            const newOnly = Object.keys(newBookData).filter(u => !(u in oldBookData));

            newOnly.forEach(nu => {
                const nList = normalizeList(newBookData[nu]);
                const nSet = new Set(nList.map(x => x.w));
                let best = null, bestOverlap = -1;
                oldOnly.forEach(ou => {
                    const oList = normalizeList(oldBookData[ou]);
                    const overlap = oList.reduce((acc, x) => acc + (nSet.has(x.w) ? 1 : 0), 0);
                    if (overlap > bestOverlap) { bestOverlap = overlap; best = ou; }
                });
                if (best) {
                    const oLen = normalizeList(oldBookData[best]).length;
                    const threshold = Math.min(nSet.size, oLen) * 0.8;
                    if (bestOverlap >= threshold) {
                        ops.push({ op: 'renameUnit', unitTitle: best, toTitle: nu });
                    }
                }
            });
            return ops;
        }

        /** 全书级别差异 → 产出 9 种 ops */
        function generateOps(oldJson, newJson) {
            const ops = [];
            const oldBD = oldJson.bookData || {};
            const newBD = newJson.bookData || {};

            const oldUnits = Object.keys(oldBD);
            const newUnits = Object.keys(newBD);

            const addUnits = newUnits.filter(u => !(u in oldBD));
            const delUnits = oldUnits.filter(u => !(u in newBD));
            const commonUnits = newUnits.filter(u => (u in oldBD));

            // 1) 新增单元 → addUnit（带完整 list）
            addUnits.forEach(u => {
                const fullList = normalizeList(newBD[u]).map(it => ({
                    id: null,
                    w: it.w,
                    def: it.def,
                    ...(it.tid ? { tid: it.tid } : {}),
                    ...(typeof it.f === 'number' ? { f: it.f } : {})
                }));
                ops.push({ op: 'addUnit', unit: { title: u, list: fullList } });
            });

            // 2) 删除单元 → removeUnit
            delUnits.forEach(u => ops.push({ op: 'removeUnit', unitTitle: u }));

            // 3) 可选：重命名单元
            ops.push(...tryGuessRenameUnits(oldBD, newBD));

            // 4) 交集单元 → 条目级（增删改移）
            commonUnits.forEach(u => {
                ops.push(...diffUnitItems(u, oldBD[u], newBD[u]));
            });

            return ops;
        }

        /** 入口：比较并渲染结果 */
        function compareJSON(json1, json2) {
            const ops = generateOps(json1, json2);
            const result = { ops };

            const out = JSON.stringify(result, null, 2);
            const pre = document.getElementById('compare-result');
            pre.textContent = out;

            document.getElementById('btn-download').disabled = false;
            document.getElementById('btn-copy').disabled = false;

            const box = document.getElementById('compare-result-content');
            box.classList.add('expanded');
            document.querySelector('[data-target="compare-result-content"] .toggle-icon i').className = 'fas fa-chevron-up';
            pre.classList.add('fade-in');
        }
    </script>
</body>

</html>